<!-- ... everything above unchanged ... -->
    <script>
        gsap.registerPlugin(ScrollTrigger);

        // Animate numbers
        function animateValue(obj, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                const currentValue = Math.floor(progress * (end - start) + start);
                if (obj.id === 'viz-revenue') {
                    obj.innerHTML = 'â‚¬' + currentValue.toLocaleString('de-DE');
                } else {
                    obj.innerHTML = currentValue.toLocaleString('de-DE');
                }
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        // DOM elements
        const vizYear = document.getElementById('viz-year');
        const vizAttendance = document.getElementById('viz-attendance');
        const vizRevenue = document.getElementById('viz-revenue');
        const vizEnthusiastsBar = document.getElementById('viz-enthusiasts-bar');
        const vizIndustryBar = document.getElementById('viz-industry-bar');
        const vizEnthusiastsLabel = document.getElementById('viz-enthusiasts-label');
        const vizIndustryLabel = document.getElementById('viz-industry-label');
        const vizPreference = document.getElementById('viz-preference');
        const vizPreferencePct = document.getElementById('viz-preference-pct');
        const visualization = document.getElementById('visualization');
        const introArrow = document.getElementById('intro-arrow');
        const keyInsights2025 = document.getElementById('key-insights-2025');

        // Data for each year
        const data = {
            '2023': {
                year: 2023,
                attendance: 8747,
                revenue: 13689,
                enthusiastsPct: 52,
                industryPct: 48,
                preference: 'Competition Films',
                preferencePct: '61.6% of Attendance',
                color: 'indigo'
            },
            '2024': {
                year: 2024,
                attendance: 8422,
                revenue: 11112,
                enthusiastsPct: 44,
                industryPct: 56,
                preference: 'Special Programmes',
                preferencePct: '51.1% of Attendance',
                color: 'amber'
            },
            '2025': {
                year: 2025,
                attendance: 6295,
                revenue: 12532,
                enthusiastsPct: 50,
                industryPct: 50,
                preference: 'Special Programmes',
                preferencePct: '52.4% of Attendance',
                color: 'teal'
            }
        };

        let currentData = { ...data['2023'] };

        function updateVisualization(year) {
            const newData = data[year];
            if (!newData) return;
            animateValue(vizAttendance, currentData.attendance, newData.attendance, 800);
            animateValue(vizRevenue, currentData.revenue, newData.revenue, 800);
            vizYear.textContent = newData.year;
            vizEnthusiastsBar.style.width = `${newData.enthusiastsPct}%`;
            vizIndustryBar.style.width = `${newData.industryPct}%`;
            vizEnthusiastsLabel.textContent = `${newData.enthusiastsPct}%`;
            vizIndustryLabel.textContent = `${newData.industryPct}%`;
            vizPreference.textContent = newData.preference;
            vizPreferencePct.textContent = newData.preferencePct;
            ['indigo', 'amber', 'teal'].forEach(c => {
                vizEnthusiastsBar.classList.remove(`bg-${c}-500`);
            });
            vizEnthusiastsBar.classList.add(`bg-${newData.color}-500`);
            currentData = { ...newData };
        }

        gsap.utils.toArray('.step').forEach((step, i) => {
            ScrollTrigger.create({
                trigger: step,
                start: "top center",
                end: "bottom center",
                onEnter: () => updateVisualization((2023 + i).toString()),
                onEnterBack: () => updateVisualization((2023 + i).toString())
            });
        });

        gsap.utils.toArray('.fade-in').forEach(elem => {
            gsap.fromTo(elem, 
                { opacity: 0, y: 30 },
                {
                    opacity: 1,
                    y: 0,
                    duration: 0.8,
                    ease: 'power2.out',
                    scrollTrigger: {
                        trigger: elem,
                        start: 'top 85%',
                        toggleActions: 'play none none none'
                    }
                }
            );
        });

        // --- Mobile visualization show/hide logic ---
        function mobilePinSetup() {
            if (window.innerWidth > 767) {
                visualization.classList.add('show-visual');
                visualization.classList.remove('hide-visual');
                window.removeEventListener('scroll', mobileScrollHandler);
                return;
            }

            visualization.classList.remove('show-visual');
            visualization.classList.remove('hide-visual');

            // Remove previous triggers for mobile logic
            if (window._mobileVizTriggers) {
                window._mobileVizTriggers.forEach(t => t.kill());
            }
            window._mobileVizTriggers = [];

            // Track state
            window._vizShouldShow = false;
            window._vizShouldHide = false;

            // Show visual when intro arrow leaves viewport
            window._mobileVizTriggers.push(
                ScrollTrigger.create({
                    trigger: introArrow,
                    start: "bottom top",
                    onEnter: () => {
                        window._vizShouldShow = true;
                        maybeShowOrHideVisualization();
                    },
                    onLeaveBack: () => {
                        window._vizShouldShow = false;
                        maybeShowOrHideVisualization();
                    }
                })
            );

            // Custom scroll event to hide when keyInsights2025 bottom hits visualization bottom
            window.addEventListener('scroll', mobileScrollHandler);
            mobileScrollHandler(); // call on setup
        }

        function mobileScrollHandler() {
            // Only run if on mobile and arrow is out of view
            if (window.innerWidth > 767) return;

            // Only consider hiding if arrow is out of view
            if (!window._vizShouldShow) {
                visualization.classList.remove('show-visual');
                visualization.classList.remove('hide-visual');
                return;
            }

            // Find visualization bottom and keyInsights2025 bottom relative to viewport
            const vizRect = visualization.getBoundingClientRect();
            const insightRect = keyInsights2025.getBoundingClientRect();

            // If the bottom of the key insights paragraph is below or exactly at the bottom of the visualization, hide it
            if (insightRect.bottom >= vizRect.bottom) {
                visualization.classList.remove('show-visual');
                visualization.classList.add('hide-visual');
            } else {
                visualization.classList.add('show-visual');
                visualization.classList.remove('hide-visual');
            }
        }

        function maybeShowOrHideVisualization() {
            // Re-run scroll logic
            mobileScrollHandler();
        }

        updateVisualization('2023');

        window.addEventListener('DOMContentLoaded', () => {
            mobilePinSetup();
        });
        window.addEventListener('resize', () => {
            ScrollTrigger.refresh();
            mobilePinSetup();
        });
    </script>
<!-- ... everything below unchanged ... -->